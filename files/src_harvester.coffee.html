<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/harvester.coffee - Log.io</title>
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <style type="text/css">
        body {
            font-family: "Open Sans",sans-serif;
            background: #EEEEEE;
        }
    </style>
</head>
<body class="yui3-skin-sam">
<div class="container-fluid" style="background: url('../assets/img/back2.png');">
    <div class="row">
        <div class="col-xs-12">
            <div class="container">
                <div class="row">
                    <div class="col-xs-6">
                        <img alt="Log.io" src="../assets/css/logo-white.png" style="height: 50px; padding: 6px;" title="Log.io">
                    </div>
                    <div class="col-xs-6 text-right">
                        <p style="margin-top: 14px; color: white;">API Documentation (v0.3.3)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-xs-12">
            <div class="container">
                <div class="row">
                    <div class="col-xs-3">
                	    

<h3>APIs</h3>
<ul class="nav nav-pills nav-stacked">
    
        <li><a href="../classes/_LogObject.html">_LogObject</a></li>
    
        <li><a href="../classes/LogHarvester.html">LogHarvester</a></li>
    
        <li><a href="../classes/LogNode.html">LogNode</a></li>
    
        <li><a href="../classes/LogServer.html">LogServer</a></li>
    
        <li><a href="../classes/LogStream.html">LogStream</a></li>
    
        <li><a href="../classes/WebServer.html">WebServer</a></li>
    
   
</ul>
                    </div>
                    <div class="col-xs-9">
                        <div class="page-header">
    <h1>src/harvester.coffee <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
fs = require &#x27;fs&#x27;
net = require &#x27;net&#x27;
events = require &#x27;events&#x27;
winston = require &#x27;winston&#x27;

###*
# Mainly used by &#x60;LogHarvester&#x60;.
# 
#  - Watches log file for changes
#  - Extracts new log messages
#  - Then emits &#x27;new_log&#x27; events.
# 
# @class LogStream
# @extends events.EventEmitter
###
class LogStream extends events.EventEmitter

  ###*
  # Initializing new &#x60;LogStream&#x60; instance
  # @constructor
  # @param {Object} name name of current log stream. Only used for debugging.
  # @param {Object} paths Array of local files paths. 
  # @param {Object} _log Winston (or compatible) logger object. Only used for debugging.
  ###
  constructor: (@name, @paths, @_log) -&gt;

  ###*
  # Initialising all file watching
  # @method watch
  ###
  watch: -&gt;
    @_log.info &quot;Starting log stream: &#x27;#{@name}&#x27;&quot;
    @_watchFile path for path in @paths
    @

  ###*
  # Watching all files under specified directory
  # @method watch
  # @param {String} path Path to directory
  ###
  _watchDirectory: (path) -&gt;
    filesUnderFolder = fs.readdirSync(path)
    for i of filesUnderFolder
      @_watchFile path + &quot;/&quot; + filesUnderFolder[i]

  ###*
  # Starting to watch file changes.
  # @method watch
  # @param {String} path Path to file or a directory
  ###
  _watchFile: (path) -&gt;
      # Checking if file exists
      if not fs.existsSync path
        @_log.error &quot;File doesn&#x27;t exist: &#x27;#{path}&#x27;. Retrying in 1000ms.&quot;
        setTimeout (=&gt; @_watchFile path), 1000
        return

      # Checking if path is a directory
      if fs.lstatSync(path).isDirectory()
        @_watchDirectory(path);
        return

      @_log.info &quot;Watching file: &#x27;#{path}&#x27;&quot;
      currSize = fs.statSync(path).size
      watcher = fs.watch path, (event, filename) =&gt;
        if event is &#x27;rename&#x27;
          # File has been rotated, start new watcher
          watcher.close()
          @_watchFile path

        if event is &#x27;change&#x27;
          # Capture file offset information for change event
          fs.stat path, (err, stat) =&gt;
            @_readNewLogs path, stat.size, currSize
            currSize = stat.size

  ###*
  # File change has been detected. Determining what has been changed and emitting &#x60;new_log&#x60; event.
  # @method watch
  # @param {String} path Path to file or a directory
  ###
  _readNewLogs: (path, curr, prev) -&gt;
    # Use file offset information to stream new log lines from file
    return if curr &lt; prev
    rstream = fs.createReadStream path,
      encoding: &#x27;utf8&#x27;
      start: prev
      end: curr

    # Emit &#x60;new_log&#x60; event for every captured log line
    rstream.on &#x27;data&#x27;, (data) =&gt;
      lines = data.split &quot;\n&quot;
      @emit &#x27;new_log&#x27;, line for line in lines when line

###*
# &#x60;LogHarvester&#x60; creates &#x60;LogStream&#x60; for each file watched and opens a persistent TCP connection to the server.
# 
# Watches local files and sends new log message to server via TCP.
# 
# On startup it announces itself as Node with Stream associations.
# 
# Log messages are sent to the server via string-delimited TCP messages.
# 
# Sample configuration:
# 
#     config =
#       nodeName: &#x27;my_server01&#x27;
#       logStreams:
#         web_server: [
#           &#x27;/var/log/nginx/access.log&#x27;,
#           &#x27;/var/log/nginx/error.log&#x27;
#         ],
#         customLogs: [
#           &quot;/var/log/myCustomLogs/&quot;
#         ],
#       server:
#         host: &#x27;0.0.0.0&#x27;,
#         port: 28777
# 
# Configuration above sends the following TCP messages to the server:
# 
#     &quot;+node|my_server01|web_server\r\n&quot;
#     &quot;+bind|node|my_server01\r\n&quot;
#     &quot;+log|web_server|my_server01|info|this is log messages\r\n&quot;
# 
# Usage:
# 
#     harvester = new LogHarvester config
#     harvester.run()
#
# @class LogHarvester
###
class LogHarvester
  
  ###*
  # Initializing new &#x60;LogHarvester&#x60; instance
  # @constructor
  # @param {Object} config harvester configuration
  ###
  constructor: (config) -&gt;
    {@nodeName, @server} = config
    @delim = config.delimiter ? &#x27;\r\n&#x27;
    @_log = config.logging ? winston
    @logStreams = (new LogStream s, paths, @_log for s, paths of config.logStreams)

  ###*
  # Run harvester and connect to server
  # @method run
  ###
  run: -&gt;
    @_connect()
    @logStreams.forEach (stream) =&gt;
      stream.watch().on &#x27;new_log&#x27;, (msg) =&gt;
        @_sendLog stream, msg if @_connected

  ###*
  # Creating TCP socket
  # @method _connect
  ###
  _connect: -&gt;
    @socket = new net.Socket
    @socket.on &#x27;error&#x27;, (error) =&gt;
      @_connected = false
      @_log.error &#x27;Unable to connect server, trying again...&#x27;
      setTimeout (=&gt; @_connect()), 2000
    @_log.info &quot;Connecting to server #{@server.host}:#{@server.port}...&quot;
    @socket.connect @server.port, @server.host, =&gt;
      @_connected = true
      @_announce()

  ###*
  # Creating TCP socket
  # @method _sendLog
  # @param {Object} stream Stream that message is received from
  # @param {String} msg Log message body
  ###
  _sendLog: (stream, msg) -&gt;
    @_log.debug &quot;Sending log: (#{stream.name}) #{msg}&quot;
    @_send &#x27;+log&#x27;, stream.name, @nodeName, &#x27;info&#x27;, msg 

  ###*
  # Registed harvester to server
  # @method _announce
  ###
  _announce: -&gt;
    snames = (l.name for l in @logStreams).join &quot;,&quot;
    @_log.info &quot;Announcing: #{@nodeName} (#{snames})&quot;
    @_send &#x27;+node&#x27;, @nodeName, snames
    @_send &#x27;+bind&#x27;, &#x27;node&#x27;, @nodeName

  ###*
  # Writing message directly to socket
  # @method _send
  # @param {String} mtype Message type
  # @param {Object} args Array of message strings
  ###
  _send: (mtype, args...) -&gt;
    @socket.write &quot;#{mtype}|#{args.join &#x27;|&#x27;}#{@delim}&quot;

exports.LogHarvester = LogHarvester
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
